# AIFS - ECMWFのデータ駆動型予測システム

## 論文情報
- **タイトル**: AIFS - ECMWF's Data-Driven Forecasting System
- **著者**: Simon Lang, Mihai Alexe, Matthew Chantry, Jesper Dramsch, Florian Pinault, Baudouin Raoult, Mariana C. A. Clare, Christian Lessig, Michael Maier-Gerber, Linus Magnusson, Zied Ben Bouallègue, Ana Prieto Nemesio, Peter D. Dueben, Andrew Brown, Florian Pappenberger, Florence Rabier
- **発表日**: 2024年5月（v2: 2024年8月）
- **arXiv ID**: 2406.01465v2

## 概要

本論文は、ヨーロッパ中期予報センター（ECMWF）が開発したデータ駆動型天気予報モデル「AIFS（Artificial Intelligence Forecasting System）」を紹介している。AIFSは機械学習ベースの天気予報モデルとして、中期的な全球天気予報において高い精度を実現している。

### 主要な特徴
- **アーキテクチャ**: グラフニューラルネットワーク（GNN）のエンコーダー・デコーダーと、スライディングウィンドウトランスフォーマープロセッサーを基盤とする
- **訓練データ**: ECMWFのERA5再解析データと、ECMWFの運用数値天気予報（NWP）解析データ
- **柔軟な設計**: モジュラー設計により、高解像度入力データでの訓練を可能にする複数レベルの並列化をサポート
- **運用状況**: ECMWFの物理ベースNWPモデルと並行して1日4回実行され、予報データはECMWFのオープンデータポリシーのもとで公開されている

## 1. イントロダクション

### 背景
正確な天気予報は、人命を救い財産を守るために社会にとって極めて重要である。近年、データ駆動型天気予報の分野で大きな進展が見られている。

### データ駆動型天気予報の発展
Google、Huawei、NVIDIAなどの研究者や技術企業が、主要な物理ベースの全球数値天気予報（NWP）モデルを多くの標準的な予報スコアで上回るデータ駆動型天気予報モデルを構築している。

**主要な先行研究**:
- Pathak et al. (2022)
- Keisler (2022)
- Lam et al. (2023) - GraphCast
- Chen et al. (2023)
- Bi et al. (2023) - Pangu-Weather
- Nguyen et al. (2023)

### 計算効率
- データ駆動型モデル: 単一GPUで数分以内に予報を生成可能
- 物理ベースNWP予報: 約1,000個のCPUが必要

### 訓練データ
データ駆動型モデルは、通常、ECMWFがEU Copernicusプログラムの一環として作成した再解析データセットERA5（Hersbach et al., 2020）のサブセットで訓練される。リアルタイム予報を生成する際は、ECMWFの4D-Var解析などの運用NWP初期条件に依存している。

### ECMWFの取り組み
ECMWFは、運用使用に対応した実験的データ駆動型予測システムの実装を決定した。これには以下が含まれる:
- データ駆動型予報モデルの実装
- エンドツーエンドのパイプライン
  - データセット生成
  - 再現可能な訓練
  - 運用推論
  - 運用検証ツールの使用
  - プロダクト生成
  - 予報データの配信

## 2. モデルアーキテクチャ

### 2.1 アーキテクチャの多様性
データ駆動型天気予報では、多様なディープラーニングアーキテクチャが採用されている:
- **ビジョントランスフォーマー**: Bi et al. (2023), Nguyen et al. (2023)
- **ニューラルオペレーター**: Pathak et al. (2022)
- **グラフニューラルネットワーク（GNN）**: Keisler (2022), Lam et al. (2023)

### 2.2 AIFSの進化

#### 第1版（2023年10月）
- Keisler (2022)とLam et al. (2023)にインスパイアされた設計
- エンコーダー-プロセッサー-デコーダー設計（Battaglia et al., 2016）
- プロセッサーグリッド: 正二十面体ベース、約10,000ノード、80,000エッジ
- 空間解像度: 約1°

#### 第2版（2024年2月アップデート）
- **空間解像度**: 約0.25°に向上
- **GNNの変更**: アテンション/トランスフォーマーベースのバリアント（Shi et al., 2021）
- **プロセッサー**: 
  - Pre-normトランスフォーマーとシフトウィンドウアテンション（Child et al., 2019; Beltagy et al., 2020; Dao, 2023; Jiang et al., 2023）
  - GELU活性化関数（Hendrycks and Gimpel, 2023）
  - 緯度帯に沿ってアテンションを計算
  - O96 八面体縮小ガウスグリッドベース（約1度の空間解像度、40,320グリッドポイント）
  - 合計16個のプロセッサー層

### 2.3 グリッド構造

#### ERA5グリッド
- エンコーダーとデコーダーは、ERA5の元の空間グリッド解像度（N320縮小ガウスグリッド、約31km）でデータを処理
- N320縮小ガウスグリッド: 542,080グリッドポイント
- 比較: 0.25°経度-緯度グリッド: 1,038,240グリッドポイント

**縮小ガウスグリッドの利点**:
- 地球全体でより均一な解像度
- 極に近い場所でのグリッド間隔の崩壊がない
- エンコーダーとデコーダーのグリッドポイントとエッジの総数が削減される

### 2.4 エンコーダー・デコーダーの動作

#### エンコーダー
- ERA5グリッドからプロセッサーグリッドへの情報集約
- 各プロセッサーグリッドポイントの周囲に特定距離のカットオフ半径を使用
- エッジ特徴: エッジの長さと方向

#### デコーダー
- 潜在状態をERA5グリッドに投影
- 各ERA5グリッドポイントは、最も近い3つのプロセッサーグリッドポイントに接続

### 2.5 特徴的な機能

#### 学習可能なパラメータ
- 入力グリッドとプロセッサーグリッドの各ノードに8個の学習可能なパラメータ（特徴）を追加
- エンコーダーとデコーダーグラフのエッジにも追加
- ネットワークが入力データに直接存在しない、またはノード/エッジ特徴として事前定義されていない有用な特徴を学習できる

#### メモリ最適化
- GPUメモリフットプリントを削減するため、順伝播時に活性化チェックポイントを広範に使用
- 中間活性化をGPUメモリに保存する代わりに、逆伝播中に再計算（Chen et al., 2016）

### 2.6 並列化戦略

#### データ並列化
- バッチを小さなサブバッチに分割
- 複数のGPU間で同時処理

#### シーケンス/テンソル並列化
- 1つのニューラルネットワークインスタンスを複数のGPUに分割（Kurth et al., 2022）
- 高解像度データでの訓練と複数の自己回帰ステップを可能にする

**実装方法**:
1. **GNNアテンション**: アテンションヘッドをGPU間でシャーディング（Jacobs et al., 2023）
2. **ノード・エッジシャーディング**: 1ホップグラフ近傍に従ってシャーディング

**利点**:
- 計算負荷をGPU間で分散してランタイムを削減
- 活性化をGPU間で分割して、1つのモデルインスタンスに利用可能なGPUメモリを増加
- 高解像度データでの訓練が可能
- 最大2048 GPUまで準線形にスケール

#### アンサンブル訓練
- 確率的スコア（例：公平スコア、Ferro 2013）に向けた訓練を可能にするデバイス間通信パターンを実装
- アンサンブルメンバーを複数のGPUに分散
- 訓練中の大規模アンサンブルの直接的な確率スコアベース最適化が可能

## 3. 訓練方法

### 3.1 基本設定
AIFSは6時間予報を生成するように訓練される:
- **入力**: t-6h、t0の大気状態（ERA5またはECMWFの運用解析）
- **出力**: t+6hの状態を予報

### 3.2 入力・出力変数

| フィールド | レベルタイプ | 入力/出力 |
|---------|-----------|---------|
| ジオポテンシャル、水平・鉛直風成分、比湿、気温 | 気圧レベル: 50, 100, 150, 200, 250, 300, 400, 500, 600, 700, 850, 925, 1000 hPa | 両方 |
| 地上気圧、平均海面気圧、地表面温度、2m気温、2m露点温度、10m水平風成分、全水蒸気量 | 地表 | 両方 |
| 全降水量、対流性降水量 | 地表 | 出力 |
| 陸海マスク、地形、サブグリッド地形の標準偏差、サブスケール地形の傾斜、日射量、緯度/経度、時刻/年間日 | 地表 | 入力 |

### 3.3 ロールアウト訓練
より長いリードタイムの予報は、モデル自身の予測から初期化する自己回帰方式（ロールアウト）で計算される。予報スコアを改善するため、訓練中にもロールアウトが使用される（Keisler, 2022）。

### 3.4 訓練プロセス

#### フェーズ1: 事前訓練（ERA5）
- **期間**: 1979年〜2020年
- **学習率スケジュール**: コサイン学習率
- **総ステップ数**: 260,000
- **学習率**: 
  - 最初の1000ステップで0から10^-4に増加
  - その後、最小3×10^-7にアニーリング

#### フェーズ2: ロールアウト訓練（ERA5）
- **期間**: 1979年〜2018年
- **学習率**: 6×10^-7
- **ロールアウト増加**: 1000訓練ステップごとに、最大72時間（12自己回帰ステップ）まで増加

#### フェーズ3: ファインチューニング（IFS解析）
- **データ**: 2019年、2020年のIFS運用解析データ
- **目的**: 予報性能のさらなる向上
- **解像度調整**: IFSフィールドを元のO1280解像度（約0.1°）からN320（約0.25°）にダウンスケール

### 3.5 最適化設定

#### オプティマイザー
- **種類**: AdamW（Loshchilov and Hutter, 2019）
- **β係数**: 0.9と0.95

#### 正規化
- 入力・出力状態: 各レベルで単位分散とゼロ平均に正規化
- 強制変数（地形など）: 最小-最大正規化

#### 損失関数
- **基本**: 面積加重平均二乗誤差（MSE）
- **損失スケーリング**: 各出力変数に適用
  - すべての予報変数が損失にほぼ等しく寄与するように経験的に選択
  - 鉛直速度の重みは減少
  - 損失重みは高度とともに線形減少（上層大気のレベルの寄与が小さい）

### 3.6 計算リソース

#### ハードウェア構成
- **バッチサイズ**: 16（データ並列化使用）
- **GPU構成**: 1つのモデルインスタンスを1ノード内の4つの40GB A100 GPU間で分割
- **総GPU数**: 64
- **精度**: 混合精度（Micikevicius et al., 2018）

#### 訓練時間
- **総訓練時間**: 約1週間

#### 推論時間
- **10日予報**: 単一A100 GPUで約2分30秒（予報データの入出力を含む）

## 4. 結果

### 4.1 全体的な予報スキル

#### アノマリー相関係数（ACC）
図4は、北半球の500 hPaジオポテンシャルのACCについて、AIFS、IFS、ERA5の予報を比較している。

**主要な知見**:
- AIFSは高い予報スキルを示す
- 長いリードタイムで**12時間以上の予報優位性**
- IFSの予報スキルは、予報モデル、データ同化システム、観測利用、大気の予測可能性の固有変動性の改善によって年々進化
- ERA5は固定システムで、予報スキルの変化は主に大気変動性に関連
- AIFSはIFSと比較して**ステップチェンジ**を表す予報スキルを示す

**予報リードタイム別の結果**:
- **2日予報（T+48）**: 99%以上のACC
- **6日予報（T+144）**: 82-88%のACC
- **10日予報（T+240）**: 45-55%のACC

### 4.2 スコアカード分析

図5は、さまざまな変数について、AIFSとIFSの異なる予報スキル指標を比較したスコアカードを示している。

#### 検証方法
1. **解析検証**: 予報が初期化された運用ECMWF解析との比較
2. **観測検証**: 
   - ラジオゾンデ観測（ジオポテンシャル、気温、風速）
   - SYNOP観測（2m気温、10m風、24時間全降水量）

#### 指標
- **ACC (ccaf)**: アノマリー相関係数
- **RMSE (rmsef)**: 平方平均平方根誤差
- **SDAF (sdaf)**: 予報アノマリーの標準偏差（予報活動）

### 4.3 対流圏の結果

#### 全体的な傾向
- AIFSは対流圏全体（100 hPaまで）でより良いスコアを示す
- 予報改善は**約10%**と大幅
- 1日目以降、AIFSはIFSよりも大幅に低い予報誤差を示す

#### 成層圏（50 hPa）
- IFSがより良いスコアを示す
- これは訓練時にこれらの気圧レベルに与えられた重みが減少したことと一致

#### 1日目の特異性
解析検証時の1日目で、AIFSがIFSより悪いスコアを示す場合がある（例：北半球・南半球外熱帯の850 hPa風速）。

**理由の考察**:
- IFS解析と予報は予報にある程度延長する相関を示す可能性がある
- しかし、ラジオゾンデ観測との検証では、この劣化は見られない

#### 100 hPaレベルの興味深い結果
- 解析検証: AIFSのジオポテンシャル（z）と気温のスコアがIFSより悪化
- ラジオゾンデ検証: 北半球外熱帯の100 hPa気温について、RMSEとACCが改善

**示唆**: 解析ベースの検証では、実際の観測に対する性能を完全には反映していない可能性がある

### 4.4 地表変数の結果

図6は、2m気温と10m風速の比較を示している。

#### 主要な知見
- AIFSの地表予報は、解析および観測との検証で**一貫してIFSより良好**
- 空間解像度は地表フィールドにとって極めて重要
- 初期の低解像度AIFS版（約1°）と比較して、現在のAIFS（約0.25°）は地表スコアで大きな改善

**具体例**:
- **2m気温RMSE**: 2-5.5K（北半球外熱帯）
- **10m風速RMSE**: 2-2.9 m/s（北半球外熱帯）

### 4.5 降水量の結果

結果はより複雑である:

#### 外熱帯
- **短期予報範囲**: AIFSはSEEPS（Rodwell et al., 2010）の面でIFSより劣る
- **長期予報範囲**: AIFSはIFSよりスキルが高い

#### 熱帯
- 全降水量の予報スキルは**一般的にIFSより改善**

### 4.6 予報活動とスムージング

#### 予報活動の減少
- AIFSの予報活動は、全体的にIFSと比較してやや減少
- 予報活動の減少は、リードタイムとともに予報フィールドの「スムージング」または「ぼやけ」を伴う
- この挙動は、Pathak et al. (2022)、Keisler (2022)、Lam et al. (2023)によっても記述されている
- グローバルスペクトルでも確認可能（図示なし）

#### スケールの変化（図7）
- **短期予報**: まだかなり多くの小規模構造を含む
- **長期予報**: これらの小規模構造が消失

#### IFS-ENSとの比較（図8）
- AIFSの予報活動減少は、IFS-ENS（ECMWFのNWPアンサンブル予報）のアンサンブル平均ほど強くない
- IFS-ENSはリードタイムとともに予測不可能な特徴をフィルタリング
- GraphCast（Lam et al., 2023）の活動はAIFSと非常に似ている

#### AIFSとGraphCastの比較
- 予報性能の差は、AIFSとIFSの差よりもはるかに小さい
- これは両方が同じデータ（ERA5）とIFS解析で訓練されていることと一致
- 訓練レジーム（ロールアウト訓練など）の類似性も寄与

**興味深い観察**:
- 年間を通じて、一方のモデルが他方よりも優れているように見える長期間が存在
- これは固有の変動性、モデルアーキテクチャの違い、訓練・ファインチューニング戦略の違いによる可能性
- 長期検証統計の必要性を強調

### 4.7 熱帯低気圧（TC）の追跡

図9は、熱帯低気圧の追跡精度を示している。

#### 位置誤差
- AIFSは**IFSよりも大幅に低い**TC位置予報誤差を示す
- 文献で報告されているデータ駆動型モデルの結果と一致（Bi et al., 2023; Lam et al., 2023）

**理由**:
- TC伝播速度の低速バイアスが減少
- これがTC予報の沿岸誤差の低減につながる

#### 強度誤差
- **TC強度誤差はIFSより大きい**
- 中心気圧と最大風速の両方で該当
- AIFSは平均してIFSよりも強度の低いTCを生成

**強度誤差の原因**:
1. ERA5とIFS解析におけるTCの平均的な低強度
2. 予報中にAIFSが予報フィールドをスムージングする傾向
3. AIFSが平均してIFSより少ないTCを生成する兆候（図示なし）

## 5. 議論と結論

### 5.1 主要な成果

#### 予報性能
AIFSは、上層大気変数と地表天気パラメータの両方で**非常に競争力のある予報性能**を示す:
- NWP解析との検証で高いスキル
- ラジオゾンデとSYNOP観測との検証で高いスキル
- 正確な熱帯低気圧追跡予報

### 5.2 制限事項と課題

#### 1. フィールドのぼやけ（Blurring）
現在のAIFS実装は、重み付きMSE損失で訓練された他のデータ駆動型天気予報モデルと同様の制限を共有している。

**問題**:
- 長いリードタイムで予報フィールドのぼやけが発生
- MSE訓練目的に起因
- モデルは予報内の誤配置構造の二重ペナルティ（Hoffman et al., 1995; Ebert et al., 2013）を避けるために暗黙的なスムージングを学習

**影響**:
- スムージングは訓練中に使用される最適化ウィンドウの長さに依存
- 極端な場合、10日目まで最適化されたモデルで生成された予報は、アンサンブル平均に類似し、活動と詳細が大幅に減少

**解決策**:
- 確率的目的に向けた訓練により、予報全体を通じてシャープな予報フィールドを生成
- これはPrice et al. (2023)によって報告された結果と一致
- 予備的な結果は有望

#### 2. ファインチューニング戦略
運用IFS解析へのファインチューニングに対する比較的アドホックなアプローチ。

**改善の余地**:
- 異なるファインチューニング戦略のより詳細な探求が有益

#### 3. 予報テンデンシーの使用
AIFSは訓練損失で「完全な」正規化状態を使用している。

**他のアプローチとの違い**:
- Keisler (2022)やLam et al. (2023)は、正規化予報テンデンシーを予測

**潜在的な欠点**:
- 潜在空間変数を物理空間にマッピングするAIFSの最後の線形層の出力が適切に正規化されていない可能性

**今後の改善**:
- 将来のAIFSアップグレードで修正される可能性
- 現在変数ごとに経験的に行われている損失スケーリングの改善戦略も促進される可能性

#### 4. 成層圏の予報スキル
現在、AIFSは高さに応じた線形損失スケーリング（Lam et al., 2023など）により、成層圏予報スキルが低下している。

**問題**:
- 成層圏の変数にはほとんど重点が置かれていない

**解決策**:
- 高さに応じた損失スケーリングの最適化により、成層圏予報スキルの向上が期待される

#### 5. 高インパクトシステムの強度
熱帯低気圧などの高インパクトシステムの強度が減少している。

**改善の可能性**:
- 高解像度再解析などの改善された入力データ
- 上記のように、予報リードタイムに伴うスムージングは、訓練損失の洗練または確率モデルの訓練によって軽減可能

### 5.3 今後の研究方向

#### 1. 確率的アンサンブル予報
AIFSのモジュラーアーキテクチャにより、高度に柔軟でスケーラブル、拡張可能である。

**進行中の研究**:
- CRPSベースの訓練（Pacchiardi et al., 2024; Kochkov et al., 2024）
- 拡散ベースの生成モデル（Sohl-Dickstein et al., 2015; Ho et al., 2020; Karras et al., 2022; Price et al., 2023）

**利点**:
- 単一のデータ駆動型予報に関連するコストが比較的小さいため、多数のメンバーからなるアンサンブル予報を実行可能

#### 2. 長期予報
- 月間および季節予報などのデータ駆動型長期予報

#### 3. 降水量フィールドの改善
- 降水量フィールドの表現改善（Chantry et al., 2024）

#### 4. 地域モデリング
- データ駆動型地域モデリング（Nipen et al., 2024）

#### 5. 観測データの統合
AIFS訓練と初期化への観測の追加:
- SYNOP観測
- 衛星観測
- 解析誤差の修正
- 改善されたポイント予報の生成

**長期目標**:
- 完全に観測駆動の予報（McNally et al., 2024）の生成を可能にする

### 5.4 オープンソース化とデータ公開

#### コードとウェイトの公開
- AIFS ソースコードとウェイトを今年後半にオープンソースライセンスでリリース予定
- Anemoiフレームワークも併せてリリース

#### 運用と公開
- AIFS予報はECMWFで1日4回実行
- ECMWFのオープンデータポリシーのもと、一般に公開

###
