# Pangu-Weather: 3次元ニューラルネットワークによる正確な中期的グローバル気象予測

## 論文情報
- **タイトル**: Accurate medium-range global weather forecasting with 3D neural networks
- **著者**: Kaifeng Bi, Lingxi Xie, Hengheng Zhang, Xin Chen, Xiaotao Gu, Qi Tian (Huawei Cloud)
- **掲載誌**: Nature, Vol 619, pp.533-538 (2023年7月20日)
- **DOI**: https://doi.org/10.1038/s41586-023-06185-3

## 概要

本論文は、人工知能（AI）ベースの気象予測システム「Pangu-Weather（盤古気象）」を紹介している。Pangu-Weatherは、現在世界最高精度とされる数値気象予測（NWP）システムであるECMWF（ヨーロッパ中期予報センター）のoperational IFSを、再解析データに対する決定論的予測において全テスト変数で上回る性能を示した。

### 主要な成果
- **精度**: ERA5再解析データに対して、全テスト変数でoperational IFSとFourCastNetを上回る精度を達成
- **速度**: operational IFSより10,000倍以上高速（単一GPUで1.4秒）
- **予測時間利得**: operational IFSに対して10-15時間、FourCastNetに対して最大40時間の予測時間利得
- **5日間Z500予測のRMSE**: 296.7（operational IFS: 333.7、FourCastNet: 462.5）

## 背景と動機

### 数値気象予測（NWP）の課題
従来のNWP手法は以下の問題を抱えている：
1. **計算コスト**: 10日間予報に数百ノードのスーパーコンピュータで数時間を要する
2. **パラメータ化誤差**: 未解決プロセスを捕捉するための近似関数が誤差の原因となる
3. **並列化の困難**: 効率的な並列計算が難しい

### AI手法の可能性と限界
深層学習による気象予測は計算速度で大きな優位性を持つが、精度面での課題があった：
- FourCastNetは100メンバー24時間予報を7秒で計算できるが、精度はNWPに及ばなかった
- 5日間Z500予測でFourCastNetのRMSEは484.5とoperational IFSの333.7に大きく劣っていた

## Pangu-Weatherの技術的貢献

### 1. 3D Earth-specific Transformer (3DEST)アーキテクチャ

#### アーキテクチャ設計
高度情報を新しい次元として統合し、入力と出力を3次元として概念化：
- **入力構造**:
  - 上層大気変数: 13気圧レベル × 1,440 × 721 × 5変数
  - 地表変数: 1,440 × 721 × 4変数
  - 空間解像度: 0.25° × 0.25°

#### 主要コンポーネント

**パッチ埋め込み (Patch Embedding)**:
- 上層大気: 2×4×4のパッチサイズで7×360×181×Cに削減
- 地表変数: 4×4のパッチサイズで360×181×Cに削減
- 基本チャンネル幅C = 192

**エンコーダ・デコーダアーキテクチャ**:
- エンコーダ: 8層（最初2層: 8×360×181×C、次6層: 8×180×91×2C）
- デコーダ: 8層（対称構造）
- Swin Transformerに基づく設計
- 合計約6400万パラメータ

**Earth-specific位置バイアス**:
従来の相対位置バイアスではなく、地球固有の絶対位置を考慮：
- 地球の球面投影による隣接トークン間の不均一な間隔を考慮
- 気圧レベル、経度、緯度の絶対座標に基づくバイアス
- パラメータ数は標準Swinの527倍だが、計算コストは同じ

#### 3Dモデルの優位性
高度を独立した次元として扱うことで：
- 異なる気圧レベル間の大気状態の関係を捕捉
- 2次元モデル（FourCastNetなど）と比較して大幅な精度向上

### 2. 階層的時間集約戦略

#### 動機
中期予報（7日以上）では累積予測誤差が問題となる。反復回数を減らすことで誤差を軽減。

#### 実装
4つの異なるリードタイム（予測間隔）のモデルを訓練：
- FM1: 1時間予測モデル
- FM3: 3時間予測モデル
- FM6: 6時間予測モデル
- FM24: 24時間予測モデル

#### 貪欲アルゴリズム
最大のリードタイムを持つモデルを優先的に使用：
- 例: 56時間予測の場合
  - FM24を2回実行（48時間）
  - FM6を1回実行（54時間）
  - FM1を2回実行（56時間）
- FourCastNet（固定6時間モデル）より高速かつ高精度

### 3. 訓練戦略

#### データ
- **訓練データ**: ERA5（1979-2017年、39年分）
- **検証データ**: 2019年
- **テストデータ**: 2018年
- **総訓練サンプル数**: 341,880時点（1エポックあたり）

#### 訓練設定
- **最適化**: Adamオプティマイザ、100エポック
- **損失関数**: 平均絶対誤差（MAE）
- **バッチサイズ**: 192（GPU当たり1サンプル）
- **学習率**: 0.0005から0へコサインスケジュールで減衰
- **計算資源**: 192台のNVIDIA Tesla-V100 GPU
- **訓練時間**: 各モデル約16日

#### 正規化と重み付け
- 各2次元フィールドを個別に正規化（平均減算、標準偏差除算）
- 変数ごとに異なる重み（早期実行での平均損失値の逆数）
  - 上層大気: Z(3.00), Q(0.60), T(1.50), U(0.77), V(0.54)
  - 地表: MSLP(1.50), U10(0.77), V10(0.66), T2M(1.50)

## 実験結果

### 1. 決定論的グローバル気象予測

#### 全体的な性能
2018年のERA5データに対する評価で、Pangu-Weatherは以下を達成：
- **全テスト変数でRMSE最小・ACC最大**
- **全リードタイム（1時間～168時間）で優位性**
- **変数によっては5日以上の予測でさらに優位性が拡大**

#### 予測時間利得（Forecast Time Gain）
同じ精度到達に必要なリードタイムの差：
- operational IFSに対して: 平均10-15時間
- 比湿など一部変数: 24時間以上の利得
- FourCastNetに対して: 最大40時間の利得

#### 地域別・変数別の詳細結果

**Z500（500hPa ジオポテンシャル）**:
- 全球: Pangu-Weather最も低いRMSE、最も高いACC
- 北半球、南半球、熱帯全てで優位
- リードタイムが長いほど優位性が顕著

**T850（850hPa 気温）**:
- 同様に全地域で優位性を維持

**Q500（500hPa 比湿）**:
- NWP手法が苦手とする変数
- Pangu-Weatherは訓練データから効果的なパターンを学習

**地表変数（T2M, U10, V10）**:
- 2m気温、10m風速成分でも一貫した優位性

### 2. 熱帯低気圧追跡

#### 追跡アルゴリズム
平均海面気圧（MSLP）の局所最小値を探索し、以下の条件を満たすものを台風の目として特定：
1. 278km半径内に最大850hPa相対渦度（北半球: >5×10⁻⁵、南半球: <-5×10⁻⁵）
2. 温帯低気圧の場合、278km半径内に850-200hPa間の最大厚さ
3. 陸上の場合、278km半径内に最大10m風速 >8 m/s

#### 性能評価
2018年の88個の名前付き熱帯低気圧に対して：
- **3日平均直接位置誤差**:
  - Pangu-Weather: 120.29 km
  - ECMWF-HRES: 162.28 km
- **5日平均直接位置誤差**:
  - Pangu-Weather: 195.65 km
  - ECMWF-HRES: 272.10 km
- リードタイムが長いほど優位性が拡大

#### 注目すべき事例

**台風Kong-rey（2018-25）**:
- 2018年世界最強クラスの熱帯低気圧の1つ
- ECMWF-HRESは中国上陸を予測したが、実際には上陸せず
- Pangu-Weatherは正確な経路を予測
- ECMWF-HRESは48時間以上遅れて正しい結論に到達

**台風Yutu（2018-26）**:
- 2018年世界最強クラス、マリアナ諸島とフィリピンに壊滅的被害
- Pangu-Weatherは上陸6日前に正確な経路（フィリピン方向）を予測
- ECMWF-HRESは初期段階で北東への大きな転向を誤予測
- ECMWF-HRESは48時間以上遅れて正しい予測に修正

**ハリケーンMichael（2018-13）**:
- 2018年大西洋ハリケーンシーズン最強
- 上陸3日前の予測で両者ともフロリダ上陸を予測
- 上陸時刻の遅れ: Pangu-Weather 3時間、ECMWF-HRES 18時間
- 上陸後の追跡でPangu-Weatherが大幅に優位

**台風Ma-on（2022-09）**:
- フィリピンと中国に影響を与えた強い熱帯暴風
- 上陸約3日前の予測でECMWF-HRESは珠海上陸を誤予測
- Pangu-Weatherの予測は実際に近い結果

#### 公平性に関する注記
ECMWF-HRESはIFS初期条件データを使用、Pangu-Weatherは再解析データを使用しており、直接比較はやや不公平である点に注意。

### 3. アンサンブル予測

#### 手法
初期気象状態に摂動を加える：
- 99個のランダム摂動を生成（Perlinノイズを使用）
- 3オクターブ（スケール: 0.2, 0.1, 0.05）
- 周期数: 12, 24, 48
- 合計100メンバーのアンサンブル予測

#### 結果
**RMSE（Root Mean Square Error）**:
- 短期予測（1日）: 単一モデルよりわずかに悪化
- 中長期予測（5-7日）: 単一モデルより大幅に改善
- 非平滑変数（Q500, U10など）で特に効果的

**CRPS（Continuous Ranked Probability Score）**:
- アンサンブル平均の精度を示す指標
- リードタイムが長いほど改善効果が大きい

**スプレッド・スキル比（Spread-Skill Ratio）**:
- 1.0未満（やや過小分散）
- 理想的には1.0に近いことが望ましい
- 改善の余地あり

#### 計算効率
NWP手法と比較してアンサンブル予測のコストを大幅に削減：
- 気象学者が専門知識を活用してノイズを制御し、精度向上が可能
- 大規模メンバーアンサンブルが実用的に

## 視覚化と解釈

### 予測結果の特徴
3日予測の視覚化（Z500, T850, T2M, 10m風速）から観察される特徴：

**Pangu-Weatherの傾向**:
- より滑らかな等高線
- 隣接領域に類似値を予測する傾向
- 回帰アルゴリズムが平均値に収束する一般的な性質

**operational IFSの傾向**:
- 滑らかさが低い
- 各グリッドセルで初期条件からPDEを解くため
- 気象のカオス性と初期条件の不確実性により統計的不確実性が生じる

### 極値の扱い
**相対分位誤差（RQE）分析**:
- Pangu-Weatherとoperational IFSは共に極値を過小評価する傾向
- Pangu-Weatherはリードタイムが長いほど過小評価が顕著
- AI手法の平滑化傾向による
- ただし、熱帯低気圧追跡では個々の極端現象を正確に捕捉

## 技術的詳細

### 数学的定式化

#### 問題設定
時刻tの全グローバル気象変数を**A**ₜとする（サイズ: Nₗₒₙ × Nₗₐₜ × 69）:
- Nₗₒₙ = 1,440（経度方向）
- Nₗₐₜ = 721（緯度方向）
- 69 = 研究対象変数数

予測タスク: 時刻t₀において**A**ₜ₀が与えられたとき、**A**ₜ₀₊Δₜを予測
- Δt: リードタイム

深層ニューラルネットワーク: f(**A**ₜ₀; θ)
- θ: 学習可能パラメータ

#### 評価指標

**RMSE（Root Mean Square Error）**:
```
RMSE(v,Δt) = √[Σᵢ Σⱼ L(φᵢ) × (Âᵢ,ⱼ,ₜᵥ - Aᵢ,ⱼ,ₜᵥ)² / (Nₗₐₜ × Nₗₒₙ)]
```
- L(φᵢ): 緯度φᵢでの重み = cos(φᵢ) / Σcos(φᵢ')

**ACC（Anomaly Correlation Coefficient）**:
```
ACC(v,Δt) = Σᵢ Σⱼ L(φᵢ) × A'ᵢ,ⱼ,ₜᵥ × Â'ᵢ,ⱼ,ₜᵥ / √[Σᵢ Σⱼ L(φᵢ) × (A'ᵢ,ⱼ,ₜᵥ)² × Σᵢ Σⱼ L(φᵢ) × (Â'ᵢ,ⱼ,ₜᵥ)²]
```
- A': 気候値（39年間の長期平均）との差

### データ準備

#### ERA5データセット
- 過去60年間のグローバル、時間ごとの再解析データ
- 観測データと数値モデル予測を数値同化手法で融合
- 最高空間解像度: 0.25° × 0.25°

#### 選択変数
**気圧レベル**: 13レベル（50, 100, 150, 200, 250, 300, 400, 500, 600, 700, 850, 925, 1000 hPa）

**上層大気変数**（5変数）:
1. ジオポテンシャル（Z）
2. 比湿（Q）
3. 気温（T）
4. 風速u成分（U）
5. 風速v成分（V）

**地表変数**（4変数）:
1. 2m気温（T2M）
2. 10m風速u成分（U10）
3. 10m風速v成分（V10）
4. 平均海面気圧（MSLP）

**定数マスク**（地表変数入力に追加）:
- 地形マスク
- 陸海マスク
- 土壌タイプマスク

### 推論速度

#### システムレベル比較
- **FourCastNet**: Tesla-A100 GPU（312 TFLOPS）で24時間予測に0.28秒
- **Pangu-Weather**: Tesla-V100 GPU（120 TFLOPS）で24時間予測に1.4秒
- GPU性能を考慮すると、Pangu-WeatherはFourCastNetより約50%遅い

#### NWPとの比較
- **operational IFS**: 数百ノードのスーパーコンピュータで数時間
- **Pangu-Weather**: 単一GPUで1.4秒
- **速度比**: 10,000倍以上高速

## 限界と課題

### 1. データソースの違い
- **訓練・テスト**: 再解析データ（ERA5）を使用
- **実運用**: 観測データを使用
- データソース間の違いによる性能への影響は要調査

### 2. 未検討の気象変数
- **降水量**: 本研究では検討されていない
- 小規模な極端気象現象（竜巻発生など）の予測に影響の可能性

### 3. 平滑化傾向
- AI手法は平滑な予測結果を生成
- 極端気象の強度を過小評価するリスク
- 熱帯低気圧追跡は検討したが、更なる研究が必要

### 4. 時間的不整合性
- 異なるリードタイムのモデル使用による時間的不整合の可能性
- さらなる調査が必要な困難なトピック

## 将来の展望

### AI側の改善方向
1. **より多くの垂直レベルと大気変数の組み込み**
2. **時間次元の統合と4次元深層ネットワークの訓練**
3. **より深い/広いネットワーク**
4. **訓練エポック数の増加**

全ての方向は、より大きなメモリとFLOPSを持つ強力なGPUクラスタを必要とする。

### NWP側の改善方向
- 予測可能なバイアスを軽減する後処理手法の開発

### 統合の可能性
AI手法とNWP手法の組み合わせにより、さらに強力な性能をもたらすことが期待される。

## 「盤古（Pangu）」の名称について

盤古は中国神話における原初の存在であり創造神話の人物。天と地を分離し、山や川などの地理的特徴となった。この名称は、Huawei Cloudが開発した事前訓練AIモデルシリーズの一部であり、コンピュータビジョン、自然言語処理、マルチモーダル理解、科学計算（気象予測を含む）などをカバーしている。

## データとコードの利用可能性

### データソース
- **ERA5データセット**: https://cds.climate.copernicus.eu/（約60TB）
- **ECMWF予測データ**: https://confluence.ecmwf.int/display/TIGGE
- **IBTrACS**: https://www.ncei.noaa.gov/products/international-best-track-archive

### コード
- **ベースフレームワーク**: PyTorch
- **参照実装**: Swin Transformer (https://github.com/microsoft/Swin-Transformer)
- **公開リポジトリ**: https://github.com/198808xc/Pangu-Weather
- **DOI**: https://doi.org/10.5281/zenodo.7678849
- **追加ライブラリ**: xskillscore (CRPS計算), perlin-numpy (Perlinノイズ), NumPy, Matplotlib

### 提供内容
1. 訓練済みモデル
2. 推論コード
3. 詳細な擬似コード
4. ERA5初期場とECMWF初期場の両方に対応（後者は準リアルタイム気象予測APIとして使用可能）

## 結論

Pangu-Weatherは、深層学習を用いた高速かつ高精度な気象予測システムであり、以下の点で画期的な成果を達成した：

1. **精度**: 再解析データに対する決定論的予測で世界最高のNWPシステムを上回る
2. **速度**: 10,000倍以上の高速化を実現
3. **汎用性**: 極端気象予測やアンサンブル予測でも優れた性能
4. **技術革新**: 3DEST アーキテクチャと階層的時間集約戦略

本研究は、大規模事前訓練モデルの様々な下流アプリケーションへの適用可能性を示し、コンピュータビジョン、自然言語処理、クロスモーダル理解などの他のAI分野と同じトレンドを示している。

ただし、実用化に向けては、観測データでの性能評価、降水量などの追加変数の組み込み、極値予測の改善、時間的整合性の確保など、いくつかの課題が残されている。今後、AI手法とNWP手法の融合により、さらなる性能向上が期待される。
